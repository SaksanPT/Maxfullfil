<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .main-card { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; background: white; margin-bottom: 30px; }
        
        .card-header { 
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); 
            color: white; padding: 20px; 
        }

        /* Table Styles */
        .table { margin-bottom: 0; }
        .table thead th { 
            background-color: #27ae60 !important; 
            color: white; 
            border: none;
            padding: 12px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer; /* ‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏°‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡πâ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            user-select: none;
        }
        .table thead th:hover {
            background-color: #1e8449 !important; /* ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ä‡∏µ‡πâ */
        }

        /* üî• Custom Row Colors (Group by PO) üî• */
        tr.group-color-1 td { background-color: #e8f8f5 !important; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• */
        tr.group-color-2 td { background-color: #ffffff !important; } /* ‡∏Ç‡∏≤‡∏ß */
        
        /* Hover Effect */
        tbody tr:hover td {
            background-color: #d1f2eb !important; 
            transition: 0.2s;
        }
        
        td { vertical-align: middle; padding: 10px; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-success">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between mb-3">
        <a href="index.html" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>
        <button onclick="exportToExcel()" class="btn btn-success rounded-pill px-4 fw-bold">
            <i class="fas fa-file-excel me-2"></i> Export Excel
        </button>
    </div>

    <div class="card main-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fas fa-dolly-flatbed me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</h4>
            <span class="badge bg-light text-success fs-6" id="rowCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="card-body">
            
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-gas-pump text-success"></i></span>
                        <select id="stationFilter" class="form-select" onchange="applyFilters()">
                            <option value="">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</option>
                            </select>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç PO, ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>

            <div class="table-responsive" style="max-height: 75vh;">
                <table class="table table-hover border" id="poTable">
                    <thead class="sticky-top shadow-sm" id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div id="noDataMsg" class="text-center py-5 text-muted" style="display:none;">
                <i class="fas fa-inbox fa-3x mb-3"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    // ‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‚ö†Ô∏è
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbweh5uYSuJKnjpbSlFmpYwaMtsem87_-WlgFMtUjf6J4Ol_wmTJQiIxvIhMPt1-Fw9B/exec';
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á API ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ User ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (‡πÅ‡∏õ‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤) ---
    async function callAPI(action, payload = {}) {
        const user = localStorage.getItem('user') || 'Guest';
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: action, username: user, ...payload })
            });
            return await response.json();
        } catch (e) {
            console.error(e);
            return null;
        }
    }
    let allData = [];      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏° Header)
    let displayData = [];  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
    let sortDirection = 1; // 1 = Asc, -1 = Desc
    let lastSortCol = -1;  // ‡∏à‡∏≥‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà Sort

    window.onload = loadPOData;

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    async function loadPOData() {
        showLoading();
        try {
            const res = await fetch(SCRIPT_URL + '?action=po_pending&t=' + new Date().getTime());
            const json = await res.json();
            
            if (json.status !== 'success') throw new Error(json.message);

            const rawData = json.data;
            if (!rawData || rawData.length === 0) {
                document.getElementById('noDataMsg').style.display = 'block';
                document.getElementById('rowCount').innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            } else {
                const headers = rawData[0];
                const body = rawData.slice(1);
                allData = [headers, ...body]; // ‡πÄ‡∏Å‡πá‡∏ö Master Data
                displayData = body;           // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sort
                renderHeader(headers);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏¢‡∏π‡πà Col Index 2: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ)
                populateStationFilter(body, 2); 

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                renderTable(body);
            }
        } catch (err) { 
            alert("Error: " + err.message); 
        } finally { 
            hideLoading(); 
        }
    }

    // --- üî• 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Header ‡πÅ‡∏ö‡∏ö‡∏Å‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ üî• ---
    function renderHeader(headers) {
        let headHTML = '<tr>';
        headers.forEach((h, index) => {
            headHTML += `<th onclick="sortTable(${index})">
                            ${h} <i class="fas fa-sort small text-white-50 ms-1"></i>
                         </th>`;
        });
        headHTML += '</tr>';
        document.getElementById('tableHead').innerHTML = headHTML;
    }

    // --- üî• 2. Logic ‡∏à‡∏±‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° PO üî• ---
    function renderTable(rows) {
        const tbody = document.getElementById('tableBody');
        const noData = document.getElementById('noDataMsg');
        
        if (rows.length === 0) {
            tbody.innerHTML = '';
            noData.style.display = 'block';
            document.getElementById('rowCount').innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            return;
        }

        noData.style.display = 'none';
        let html = '';
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ
        let lastPO = null;
        let isGroup1 = true; // true = ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, false = ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß

        rows.forEach(row => {
            const currentPO = row[0]; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ PO ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (Index 0)

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏Ç PO ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ
            if (currentPO !== lastPO) {
                isGroup1 = !isGroup1;
                lastPO = currentPO;
            }

            const rowClass = isGroup1 ? 'group-color-1' : 'group-color-2';

            html += `<tr class="${rowClass}">`;
            row.forEach(cell => {
                html += `<td>${cell}</td>`;
            });
            html += '</tr>';
        });

        tbody.innerHTML = html;
        document.getElementById('rowCount').innerText = `${rows.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    }

    // --- üî• 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown Filter üî• ---
    function populateStationFilter(rows, colIndex) {
        const select = document.getElementById('stationFilter');
        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
        const stations = [...new Set(rows.map(r => r[colIndex]))].sort();
        
        stations.forEach(station => {
            if(station) { // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                const option = document.createElement('option');
                option.value = station;
                option.text = station;
                select.appendChild(option);
            }
        });
    }

    // --- üî• 4. ‡∏£‡∏∞‡∏ö‡∏ö Filter (‡∏£‡∏ß‡∏° Search + Dropdown) üî• ---
    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const stationVal = document.getElementById('stationFilter').value;
        const stationColIndex = 2; // Index ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏∑‡∏≠ Col 3 ‡πÅ‡∏ï‡πà index array ‡∏Ñ‡∏∑‡∏≠ 2)

        const body = allData.slice(1);

        const filtered = body.filter(row => {
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ Dropdown
            const matchStation = (stationVal === "") || (row[stationColIndex] === stationVal);
            
            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ Text Search (‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
            const matchText = row.some(cell => String(cell).toLowerCase().includes(searchText));

            return matchStation && matchText;
        });

        displayData = filtered; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        renderTable(filtered);
    }

    // --- üî• 5. ‡∏£‡∏∞‡∏ö‡∏ö Sort (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) üî• ---
    function sortTable(colIndex) {
        // ‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏°
        if (lastSortCol === colIndex) {
            sortDirection *= -1;
        } else {
            sortDirection = 1;
            lastSortCol = colIndex;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• displayData (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà)
        displayData.sort((a, b) => {
            let valA = a[colIndex];
            let valB = b[colIndex];

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                valA = parseFloat(valA);
                valB = parseFloat(valB);
            } else {
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
            }

            if (valA < valB) return -1 * sortDirection;
            if (valA > valB) return 1 * sortDirection;
            return 0;
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï icon ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Optional UI polish)
        updateHeaderIcons(colIndex, sortDirection);

        renderTable(displayData);
    }

    function updateHeaderIcons(colIndex, dir) {
        const headers = document.querySelectorAll('#tableHead th i');
        headers.forEach((icon, idx) => {
            icon.className = 'fas fa-sort small text-white-50 ms-1'; // Reset
            if (idx === colIndex) {
                icon.className = dir === 1 ? 'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1';
                icon.classList.remove('text-white-50');
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export Excel (Export ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
    function exportToExcel() {
        if (displayData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export"); return; }
        
        const wb = XLSX.utils.book_new();
        // ‡πÄ‡∏≠‡∏≤ Header ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
        const exportData = [allData[0], ...displayData];
        const ws = XLSX.utils.aoa_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, "PO_Pending");
        XLSX.writeFile(wb, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö.xlsx");
    }
</script>

</body>

</html>
