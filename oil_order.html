<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á & Shipto</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; }
        .main-card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; background: white; margin-bottom: 20px; }
        .card-header { background: #34495e; color: white; padding: 15px 20px; }
        
        .table { border-collapse: separate; border-spacing: 0; }
        .table thead th { 
            background-color: #2c3e50; 
            color: white; 
            vertical-align: middle;
            text-align: center;
            font-size: 0.9rem;
            position: sticky; top: 0; z-index: 10;
        }
        
        /* üî• ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ Class (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏µ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß) üî• */
        .bg-class-a, .bg-class-a > td { background-color: #d4edda !important; } /* A = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .bg-class-b, .bg-class-b > td { background-color: #fff3cd !important; } /* B = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
        .bg-class-c, .bg-class-c > td { background-color: #f8d7da !important; } /* C = ‡πÅ‡∏î‡∏á */
        
        .qty-input { 
            width: 100px; 
            text-align: center; 
            border: 2px solid #ced4da; 
            border-radius: 5px;
            background-color: #fff !important; /* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏™‡∏°‡∏≠ */
        }
        .qty-input:focus { border-color: #3498db; box-shadow: 0 0 5px rgba(52,152,219,0.5); outline: none; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between mb-3">
        <a href="index.html" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>
        <div class="d-flex gap-2">
            <button onclick="clearShipto()" class="btn btn-danger rounded-pill px-4">
                <i class="fas fa-trash-alt me-2"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡∏µ‡∏ó Shipto
            </button>
            <button onclick="saveData()" class="btn btn-primary rounded-pill px-4 fw-bold">
                <i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
            </button>
        </div>
    </div>

    <div class="card main-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="m-0"><i class="fas fa-gas-pump me-2"></i>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á & Shipto</h5>
            <span class="badge bg-light text-dark fs-6" id="rowCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="card-body">
            
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-filter text-primary"></i></span>
                        <select id="plantFilter" class="form-select" onchange="filterTable()">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏£‡∏´‡∏±‡∏™..." onkeyup="filterTable()">
                    </div>
                </div>
            </div>

            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-bordered table-hover" id="oilTable">
                    <thead>
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</th>
                            <th>Class</th>
                            <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ(‡∏ä‡∏¥‡πâ‡∏ô)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á(‡∏ä‡∏¥‡πâ‡∏ô)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢30‡∏ß‡∏±‡∏ô(‡∏ä‡∏¥‡πâ‡∏ô)</th>
                            <th class="bg-warning text-dark" style="width: 120px;">‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div id="noDataMsg" class="text-center py-5 text-muted" style="display:none;">
                <i class="fas fa-inbox fa-3x mb-3"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ URL ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Deployment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚ö†Ô∏è
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDhROGmEtVLx9p202hfS44dOARYM7g-x_33tIcXU_olgrcrW6wVmcyLioa1J3l3nc_/exec';
    
    let allData = [];

    window.onload = loadData;

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    async function loadData() {
        showLoading();
        try {
            const res = await fetch(SCRIPT_URL + '?action=oil_order&t=' + new Date().getTime());
            const json = await res.json();
            
            if (json.status !== 'success') throw new Error(json.message);

            allData = json.data; 

            // üî• ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Class (A -> B -> C)
            allData.sort((a, b) => {
                let classA = String(a[2] || '').trim().toUpperCase();
                let classB = String(b[2] || '').trim().toUpperCase();
                if (classA < classB) return -1;
                if (classA > classB) return 1;
                return 0;
            });
            
            populateFilter(allData, 1);
            renderTable(allData);

        } catch (err) { 
            Swal.fire('Error', err.message, 'error');
        } finally { 
            hideLoading(); 
        }
    }

    function renderTable(rows) {
        const tbody = document.getElementById('tableBody');
        const noData = document.getElementById('noDataMsg');
        
        if (!rows || rows.length === 0) {
            tbody.innerHTML = '';
            noData.style.display = 'block';
            document.getElementById('rowCount').innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            return;
        }

        noData.style.display = 'none';
        let html = '';
        
        rows.forEach((row, index) => {
            // üî• Logic ‡∏™‡∏µ Class (‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á "A" ‡πÅ‡∏•‡∏∞ "Class A")
            let classVal = String(row[2]).trim().toUpperCase();
            let rowClass = '';

            if (classVal === 'A' || classVal.includes('CLASS A')) rowClass = 'bg-class-a';
            else if (classVal === 'B' || classVal.includes('CLASS B')) rowClass = 'bg-class-b';
            else if (classVal === 'C' || classVal.includes('CLASS C')) rowClass = 'bg-class-c';

            html += `<tr class="${rowClass}">
                        <td>${row[0]}</td>
                        <td>${row[1]}</td>
                        <td class="fw-bold text-center">${row[2]}</td>
                        <td>${row[3]}</td>
                        <td class="text-start">${row[4]}</td>
                        <td class="text-end">${row[5]}</td>
                        <td class="text-end">${row[6]}</td>
                        <td class="text-end fw-bold text-primary">${row[7].toLocaleString()}</td>
                        <td class="text-center p-1 bg-white">
                            <input type="number" class="qty-input form-control-sm" 
                                   placeholder="0">
                        </td>
                     </tr>`;
        });

        tbody.innerHTML = html;
        document.getElementById('rowCount').innerText = `${rows.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    }

    function populateFilter(data, colIndex) {
        const select = document.getElementById('plantFilter');
        const uniqueValues = [...new Set(data.map(r => r[colIndex]))].sort();
        
        uniqueValues.forEach(val => {
            if(val) {
                const option = document.createElement('option');
                option.value = val;
                option.text = val;
                select.appendChild(option);
            }
        });
    }

    function filterTable() {
        const plantVal = document.getElementById('plantFilter').value;
        const searchVal = document.getElementById('searchInput').value.toLowerCase();

        const filtered = allData.filter(row => {
            const matchPlant = (plantVal === "") || (row[1] === plantVal);
            const matchSearch = row.some(cell => String(cell).toLowerCase().includes(searchVal));
            return matchPlant && matchSearch;
        });

        renderTable(filtered);
    }

    async function saveData() {
        const inputs = document.querySelectorAll('.qty-input');
        let itemsToSave = [];

        inputs.forEach(input => {
            let val = input.value.trim();
            if (val !== "" && parseFloat(val) > 0) {
                let tr = input.closest('tr');
                let tds = tr.querySelectorAll('td');
                
                let item = [
                    tds[0].innerText, 
                    tds[1].innerText, 
                    tds[3].innerText, 
                    tds[4].innerText, 
                    val               
                ];
                itemsToSave.push(item);
            }
        });

        if (itemsToSave.length === 0) {
            Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warning');
            return;
        }

        if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${itemsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;

        showLoading();
        try {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: 'save_shipto',
                    items: itemsToSave
                })
            });
            const json = await res.json();
            
            if (json.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message, 'success');
                inputs.forEach(inp => inp.value = '');
            } else {
                throw new Error(json.message);
            }
        } catch (err) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function clearShipto() {
        const result = await Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
            text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Shipto ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        });

        if (result.isConfirmed) {
            showLoading();
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: 'clear_shipto' })
                });
                const json = await res.json();
                
                if (json.status === 'success') {
                    Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', json.message, 'success');
                } else {
                    throw new Error(json.message);
                }
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }
    }
</script>

</body>
</html>