<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á & Shipto</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f4f6f9; 
            font-size: 16px; 
        }
        
        .main-card { 
            border: none; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            background: white; 
            margin-bottom: 20px; 
        }
        
        .card-header { 
            background: #34495e; 
            color: white; 
            padding: 15px 20px; 
            font-size: 1.1rem;
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        .table thead th { 
            background-color: #2c3e50; 
            color: white; 
            vertical-align: middle; 
            text-align: center;
            font-size: 0.95rem;
            padding: 12px 8px;
            white-space: nowrap;
            position: sticky; top: 0; z-index: 10;
        }
        
        .table tbody td {
            vertical-align: middle;
            padding: 10px 8px;
            font-size: 0.95rem;
        }

        /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
        .col-station-id { min-width: 80px; text-align: center; }
        .col-station-name { min-width: 200px; }
        .col-class { min-width: 60px; text-align: center; }
        .col-mat-id { min-width: 100px; text-align: center; }
        .col-mat-name { min-width: 250px; }
        .col-num { min-width: 80px; text-align: right; }
        .col-input { min-width: 100px; text-align: center; }

        /* Logic ‡∏™‡∏µ Class */
        table.table tbody tr.bg-class-a > td { background-color: #d1e7dd !important; }
        table.table tbody tr.bg-class-b > td { background-color: #fff3cd !important; }
        table.table tbody tr.bg-class-c > td { background-color: #f8d7da !important; }
        
        /* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô */
        .qty-input { 
            width: 100%; 
            max-width: 120px;
            height: 38px;
            text-align: center; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
            font-size: 1rem;
            background-color: #fff !important; 
        }
        .qty-input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.25); }
        
        /* Select2 ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
        .select2-container--bootstrap-5 .select2-selection { 
            min-height: 45px; 
            font-size: 1.1rem; 
            padding-top: 5px;
        }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold" href="dashboard.html"><i class="fas fa-gas-pump me-2"></i> ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</a></li>
                <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link active" href="oil_order.html">‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid px-4 py-5" style="margin-top: 20px;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="index.html" class="btn btn-outline-secondary btn-lg px-4">
            <i class="fas fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>
        <div class="d-flex gap-2">
            <button onclick="clearShipto()" class="btn btn-danger btn-lg px-4">
                <i class="fas fa-trash-alt me-2"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡∏µ‡∏ó Shipto
            </button>
            <button onclick="saveData()" class="btn btn-primary btn-lg px-4 fw-bold shadow-sm">
                <i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>
    </div>

    <div class="card main-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="m-0"><i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (POWER_BI)</h5>
            <span class="badge bg-white text-dark fs-6 shadow-sm" id="rowCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="card-body p-4">
            
            <div class="mb-4">
                <label class="form-label fw-bold text-muted" style="font-size: 1.1rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</label>
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white"><i class="fas fa-search text-primary"></i></span>
                    <select id="stationSelect" class="form-select">
                        <option value="">-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ --</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive" style="max-height: 65vh; border: 1px solid #dee2e6;">
                <table class="table table-bordered table-hover mb-0" id="oilTable">
                    <thead>
                        <tr>
                            <th class="col-station-id">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</th>
                            <th class="col-station-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</th>
                            <th class="col-class">Class</th>
                            <th class="col-mat-id">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="col-mat-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="col-num">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th class="col-num">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á</th>
                            <th class="col-num">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (30‡∏ß‡∏±‡∏ô)</th>
                            <th class="bg-warning text-dark col-input">‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div id="noDataMsg" class="text-center py-5 text-muted" style="display:none;">
                <i class="fas fa-inbox fa-4x mb-3 text-secondary"></i><br>
                <span class="fs-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ</span>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbweh5uYSuJKnjpbSlFmpYwaMtsem87_-WlgFMtUjf6J4Ol_wmTJQiIxvIhMPt1-Fw9B/exec';
    
    let allData = [];

    window.onload = loadData;

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    async function loadData() {
        showLoading();
        try {
            const res = await fetch(SCRIPT_URL + '?action=oil_order&t=' + new Date().getTime());
            const json = await res.json();
            
            if (json.status !== 'success') throw new Error(json.message);

            allData = json.data || [];

            if (allData.length > 0) {
                // Sort Logic
                allData.sort((a, b) => {
                    let cA = String(a[2] || '').trim().toUpperCase();
                    let cB = String(b[2] || '').trim().toUpperCase();
                    if (cA < cB) return -1; if (cA > cB) return 1; return 0;
                });
            }
            
            initSelect2(allData);
            renderTable(allData);

        } catch (err) { 
            console.error(err);
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + err.message, 'error');
        } finally { 
            hideLoading(); 
        }
    }

    function initSelect2(data) {
        const select = $('#stationSelect');
        const stations = new Set();
        data.forEach(r => { if (r[0] && r[1]) stations.add(`${r[0]} : ${r[1]}`); });
        Array.from(stations).sort().forEach(st => { select.append(new Option(st, st, false, false)); });

        select.select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...',
            allowClear: true
        });

        select.on('select2:select', function (e) {
            const selectedText = e.params.data.id; 
            const stationCode = selectedText.split(' : ')[0]; 
            const filtered = allData.filter(r => r[0] === stationCode);
            renderTable(filtered);
        });

        select.on('select2:clear', function (e) { renderTable(allData); });
    }

    function renderTable(rows) {
        const tbody = document.getElementById('tableBody');
        const noData = document.getElementById('noDataMsg');
        
        if (!rows || rows.length === 0) {
            tbody.innerHTML = '';
            noData.style.display = 'block';
            document.getElementById('rowCount').innerText = "0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
            return;
        }

        noData.style.display = 'none';
        let html = '';
        
        rows.forEach(row => {
            // Logic ‡∏™‡∏µ Class
            let classVal = String(row[2] || '').trim().toUpperCase();
            let rowClass = '';

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
            if (classVal === 'A' || classVal === 'CLASS A' || classVal.endsWith(' A')) {
                rowClass = 'bg-class-a';
            } else if (classVal === 'B' || classVal === 'CLASS B' || classVal.endsWith(' B')) {
                rowClass = 'bg-class-b';
            } else if (classVal === 'C' || classVal === 'CLASS C' || classVal.endsWith(' C')) {
                rowClass = 'bg-class-c';
            }

            // üî• ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 30 ‡∏ß‡∏±‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° * 30) üî•
            let salesAvg = parseFloat(row[7]) || 0;
            let sales30Days = salesAvg * 30; // ‡∏Ñ‡∏π‡∏ì 30 ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            
            // Format ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            let salesShow = sales30Days.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            html += `<tr class="${rowClass}">
                        <td class="col-station-id fw-bold">${row[0]}</td>
                        <td class="col-station-name">${row[1]}</td>
                        <td class="col-class fw-bold text-center">${row[2]}</td>
                        <td class="col-mat-id text-center">${row[3]}</td>
                        <td class="col-mat-name">${row[4]}</td>
                        <td class="col-num text-end">${row[5]}</td>
                        <td class="col-num text-end">${row[6]}</td>
                        <td class="col-num text-end fw-bold text-primary">${salesShow}</td>
                        <td class="col-input p-1 bg-white">
                            <input type="number" class="qty-input" placeholder="0">
                        </td>
                      </tr>`;
        });

        tbody.innerHTML = html;
        document.getElementById('rowCount').innerText = `${rows.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    }

    async function saveData() {
        const inputs = document.querySelectorAll('.qty-input');
        let itemsToSave = [];

        inputs.forEach(input => {
            let val = input.value.trim();
            if (val !== "" && parseFloat(val) > 0) {
                let tr = input.closest('tr');
                let tds = tr.querySelectorAll('td');
                itemsToSave.push([ 
                    tds[0].innerText, // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
                    tds[1].innerText, // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
                    tds[3].innerText, // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    tds[4].innerText, // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    val 
                ]);
            }
        });

        if (itemsToSave.length === 0) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warning'); return; }
        if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${itemsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;

        showLoading();
        try {
            const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: 'save_shipto', items: itemsToSave }) });
            const json = await res.json();
            if (json.status === 'success') { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', json.message, 'success'); inputs.forEach(inp => inp.value = ''); } 
            else { throw new Error(json.message); }
        } catch (err) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error'); } finally { hideLoading(); }
    }

    async function clearShipto() {
        const result = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢!' });
        if (result.isConfirmed) {
            showLoading();
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: 'clear_shipto' }) });
                const json = await res.json();
                if (json.status === 'success') Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', json.message, 'success'); else throw new Error(json.message);
            } catch (err) { Swal.fire('Error', err.message, 'error'); } finally { hideLoading(); }
        }
    }
</script>

</body>
</html>
