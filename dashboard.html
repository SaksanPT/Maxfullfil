<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Class A + Forecast</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .dashboard-card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; background: white; margin-bottom: 20px; }
        .card-header { padding: 15px 20px; }
        
        /* Custom Tab Styles */
        .nav-tabs .nav-link { color: #666; font-weight: bold; border: none; border-bottom: 3px solid transparent; cursor: pointer; }
        .nav-tabs .nav-link.active { color: #d32f2f; border-bottom: 3px solid #d32f2f; background: none; }
        .nav-tabs .nav-link:hover { color: #b71c1c; }

        .stat-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; height: 100%; border-left: 5px solid #ccc; }
        .stat-number { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #666; font-size: 0.9rem; }
        
        /* Colors for Current Stats */
        .border-blue { border-left-color: #3498db; } .text-blue { color: #3498db; }
        .border-red { border-left-color: #e74c3c; } .text-red { color: #e74c3c; }
        .border-orange { border-left-color: #f39c12; } .text-orange { color: #f39c12; }
        .border-green { border-left-color: #27ae60; } .text-green { color: #27ae60; }
        
        /* Colors for Forecast Stats (Theme Purple) */
        .border-fc-total { border-left-color: #6c757d; } .text-fc-total { color: #6c757d; }
        .border-fc-red { border-left-color: #c0392b; background-color: #fff5f5; } .text-fc-red { color: #c0392b; }
        .border-fc-orange { border-left-color: #d35400; } .text-fc-orange { color: #d35400; }
        .border-fc-green { border-left-color: #16a085; } .text-fc-green { color: #16a085; }

        .border-info { border-left-color: #17a2b8; } .text-info { color: #17a2b8; }
        .border-purple { border-left-color: #9b59b6; } .text-purple { color: #9b59b6; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        .sortable-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable-header:hover { background-color: #0d6efd !important; opacity: 0.9; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
</div>

<div class="container py-4">
    <div class="d-flex justify-content-between mb-3">
        <a href="index.html" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <button onclick="saveDailyStats()" class="btn btn-success fw-bold"><i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>

    <h5 class="text-muted mb-2"><i class="fas fa-thumbtack me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Today)</h5>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card border-blue"><div class="stat-number text-blue" id="statTotal">-</div><div class="stat-label">Class A ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-red"><div class="stat-number text-red" id="statZero">-</div><div class="stat-label">‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î (J=0)</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-orange"><div class="stat-number text-orange" id="statPercent">-%</div><div class="stat-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-green"><div class="stat-number text-green" id="statNonZeroPercent">-%</div><div class="stat-label">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (J‚â†0)</div></div></div>
    </div>

    <h5 class="text-muted mb-2 mt-4"><i class="fas fa-magic me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ME2N)</h5>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card border-fc-total"><div class="stat-number text-fc-total" id="fcTotal">-</div><div class="stat-label">Class A ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-fc-red"><div class="stat-number text-fc-red" id="fcZero">-</div><div class="stat-label">‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-fc-orange"><div class="stat-number text-fc-orange" id="fcPercent">-%</div><div class="stat-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå)</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-fc-green"><div class="stat-number text-fc-green" id="fcNonZeroPercent">-%</div><div class="stat-label">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå)</div></div></div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-2 mb-md-0">
            <div class="stat-card border-info d-flex align-items-center justify-content-between px-4 py-3">
                <div class="text-start">
                    <h2 class="stat-number text-info mb-0" id="statDOH">-</h2>
                    <div class="stat-label text-muted">DOH ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
                </div>
                <i class="fas fa-box-open fa-2x text-info opacity-50"></i>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card border-purple d-flex align-items-center justify-content-between px-4 py-3">
                <div class="text-start">
                    <h2 class="stat-number text-purple mb-0" id="statFcDOH">-</h2>
                    <div class="stat-label text-muted">Forecast DOH (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
                </div>
                <i class="fas fa-chart-line fa-2x text-purple opacity-50"></i>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="dashboard-card card">
                <div class="card-header bg-dark text-white"><h5 class="m-0"><i class="fas fa-chart-line me-2"></i>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° % ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</h5></div>
                <div class="card-body"><div style="height: 300px;"><canvas id="myChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="dashboard-card card">
                <div class="card-header bg-warning text-dark"><h5 class="m-0"><i class="fas fa-chart-pie me-2"></i>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î (‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏° SKU)</h5></div>
                <div class="card-body"><div style="height: 300px;"><canvas id="skuChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="dashboard-card card">
        <div class="card-header bg-white border-bottom">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="tab-stockout" onclick="switchTab('stockout')"><i class="fas fa-exclamation-triangle me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î (Stock=0)</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-doh" onclick="switchTab('doh')"><i class="fas fa-cubes me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ DOH (Current)</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-forecast" onclick="switchTab('forecast')"><i class="fas fa-binoculars me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (After PO)</button></li>
            </ul>
        </div>
        <div class="card-body">
            <div class="row mb-3 align-items-center">
                <div class="col-md-5"><input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (PO, Material, Desc)..." onkeyup="filterTable()"></div>
                <div class="col-md-7 text-end">
                    <span id="lastUpdate" class="text-muted small me-2">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</span>
                    <button onclick="exportToExcel()" class="btn btn-outline-success btn-sm fw-bold"><i class="fas fa-file-excel"></i> Export Excel</button>
                    <button onclick="loadDashboardData()" class="btn btn-light btn-sm fw-bold text-danger"><i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle table-sm" id="dashTable" style="font-size: 0.95rem;">
                    <thead class="table-dark text-center" id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDhROGmEtVLx9p202hfS44dOARYM7g-x_33tIcXU_olgrcrW6wVmcyLioa1J3l3nc_/exec'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    
    Chart.register(ChartDataLabels);

    let allClassAData = []; 
    let currentMode = 'stockout'; 
    let dohSortOrder = 'asc'; 
    let myChart = null;
    let skuChart = null;

    window.onload = function() { loadDashboardData(); loadHistoryChart(); };
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
    function switchTab(mode) { 
        currentMode = mode; 
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');
        if(mode === 'doh' || mode === 'forecast') dohSortOrder = 'asc';
        renderTableWithMode();
    }
    function toggleDohSort() {
        if(currentMode !== 'doh' && currentMode !== 'forecast') return;
        dohSortOrder = (dohSortOrder === 'asc') ? 'desc' : 'asc';
        renderTableWithMode();
    }

    async function loadDashboardData() {
        showLoading();
        try {
            const res = await fetch(SCRIPT_URL + '?action=dashboard&t=' + new Date().getTime());
            const json = await res.json();
            if (json.status !== 'success') throw new Error(json.message);

            if (json.stats) {
                // --- Current Stats ---
                const total = json.stats.totalClassA;
                const zero = json.stats.zeroStock;
                const nonZero = total - zero;
                const zeroPercent = total > 0 ? ((zero / total) * 100).toFixed(2) : 0;
                const nonZeroPercent = total > 0 ? ((nonZero / total) * 100).toFixed(2) : 0;
                const dohVal = parseFloat(json.stats.totalDOH || 0);

                document.getElementById('statTotal').innerText = total.toLocaleString();
                document.getElementById('statZero').innerText = zero.toLocaleString();
                document.getElementById('statPercent').innerText = zeroPercent + "%";
                document.getElementById('statNonZeroPercent').innerText = nonZeroPercent + "%";
                document.getElementById('statDOH').innerText = dohVal.toFixed(2) + " ‡∏ß‡∏±‡∏ô";

                // --- Forecast Stats ---
                const fcZero = json.stats.fcZeroStock || 0;
                const fcNonZero = total - fcZero;
                const fcZeroPercent = total > 0 ? ((fcZero / total) * 100).toFixed(2) : 0;
                const fcNonZeroPercent = total > 0 ? ((fcNonZero / total) * 100).toFixed(2) : 0;
                const fcDohVal = parseFloat(json.stats.fcTotalDOH || 0);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error)
                if(document.getElementById('fcTotal')) document.getElementById('fcTotal').innerText = total.toLocaleString();
                if(document.getElementById('fcZero')) document.getElementById('fcZero').innerText = fcZero.toLocaleString();
                if(document.getElementById('fcPercent')) document.getElementById('fcPercent').innerText = fcZeroPercent + "%";
                if(document.getElementById('fcNonZeroPercent')) document.getElementById('fcNonZeroPercent').innerText = fcNonZeroPercent + "%";
                if(document.getElementById('statFcDOH')) document.getElementById('statFcDOH').innerText = fcDohVal.toFixed(2) + " ‡∏ß‡∏±‡∏ô";
            }

            allClassAData = json.data || []; 
            const zeroStockItems = allClassAData.filter(r => parseFloat(r[5]) === 0);
            renderSkuChart(zeroStockItems);
            renderTableWithMode();
            document.getElementById('lastUpdate').innerText = `Updated: ${new Date().toLocaleTimeString('th-TH')}`;
        } catch (err) { alert("Error: " + err.message); }
        finally { hideLoading(); }
    }

    function renderTableWithMode() {
        const thead = document.getElementById('tableHeader');
        let displayData = [];
        // [0:PO, 1:Plant, 2:Class, 3:Mat, 4:Desc, 5:Stock, 6:Unit, 7:Sale30, 8:DOH, 9:AvgSale, 10:Pending, 11:FcStock, 12:FcDOH]

        if (currentMode === 'stockout') {
            thead.innerHTML = `<tr><th>PO</th><th>Plant</th><th>Material</th><th>Description</th><th class="bg-danger text-white">Stock</th><th>Unit</th><th class="bg-warning text-dark">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 30 ‡∏ß‡∏±‡∏ô</th></tr>`;
            displayData = allClassAData.filter(r => parseFloat(r[5]) === 0);
        } else if (currentMode === 'doh') {
            let sortIcon = (dohSortOrder === 'asc') ? '<i class="fas fa-sort-amount-down-alt ms-2"></i>' : '<i class="fas fa-sort-amount-up ms-2"></i>';
            thead.innerHTML = `<tr><th>PO</th><th>Plant</th><th>Material</th><th>Description</th><th class="bg-secondary text-white">Stock</th><th class="bg-info text-white">Avg Sales/Day</th><th class="bg-primary text-white sortable-header" onclick="toggleDohSort()" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö">DOH (‡∏ß‡∏±‡∏ô) ${sortIcon}</th></tr>`;
            displayData = [...allClassAData].sort((a,b) => (dohSortOrder === 'asc') ? (a[8]-b[8]) : (b[8]-a[8]));
        } else if (currentMode === 'forecast') {
            let sortIcon = (dohSortOrder === 'asc') ? '<i class="fas fa-sort-amount-down-alt ms-2"></i>' : '<i class="fas fa-sort-amount-up ms-2"></i>';
            thead.innerHTML = `<tr><th>Plant</th><th>Material</th><th class="bg-secondary text-white">Stock ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th><th class="bg-warning text-dark">‡∏£‡∏≠‡∏£‡∏±‡∏ö (Liters)</th><th class="bg-success text-white">‡∏£‡∏ß‡∏° Stock (Calc)</th><th class="bg-info text-white">Avg Sale</th><th class="bg-purple text-white sortable-header" onclick="toggleDohSort()" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö Forecast DOH">FC DOH ${sortIcon}</th></tr>`;
            displayData = [...allClassAData].sort((a,b) => (dohSortOrder === 'asc') ? (a[12]-b[12]) : (b[12]-a[12]));
        }
        renderTableBody(displayData);
    }

    function renderTableBody(rows) {
        const tbody = document.getElementById('tableBody');
        const v = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rows.filter(r => r.some(c => String(c).toLowerCase().includes(v)));
        let html = '';
        if (filtered.length === 0) { html = '<tr><td colspan="100%" class="text-center py-5">‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; } 
        else {
            filtered.forEach(row => {
                let stock = Number(row[5]).toLocaleString();
                let avgSale = Number(row[9]).toFixed(2);
                html += '<tr>';
                if (currentMode === 'stockout') {
                     html += `<td>${row[0]}</td><td>${row[1]}</td><td>${row[3]}</td><td class="text-start">${row[4]}</td><td class="fw-bold text-danger">0</td><td>${row[6]}</td><td class="fw-bold text-end">${Number(row[7]).toLocaleString()}</td>`;
                } else if (currentMode === 'doh') {
                     let dohShow = (row[8] > 9000) ? "‚àû" : Number(row[8]).toFixed(2);
                     let dohClass = (row[8] < 7) ? "text-danger fw-bold" : (row[8] < 15) ? "text-warning fw-bold" : "text-success";
                     html += `<td>${row[0]}</td><td>${row[1]}</td><td>${row[3]}</td><td class="text-start">${row[4]}</td><td>${stock}</td><td class="text-info">${avgSale}</td><td class="${dohClass}">${dohShow}</td>`;
                } else if (currentMode === 'forecast') {
                     let pending = Number(row[10]);
                     let fcStock = Number(row[11]);
                     let fcDoh = row[12];
                     let pendingShow = pending > 0 ? `+${pending.toLocaleString()}` : "-";
                     let pendingClass = pending > 0 ? "text-warning fw-bold" : "text-muted opacity-25";
                     let dohShow = (fcDoh > 9000) ? "‚àû" : Number(fcDoh).toFixed(2);
                     let dohClass = (fcDoh < 7) ? "text-danger fw-bold" : (fcDoh < 15) ? "text-warning fw-bold" : "text-success";
                     html += `<td>${row[1]}</td><td>${row[3]} <small class="d-block text-muted text-truncate" style="max-width:150px;">${row[4]}</small></td><td>${stock}</td><td class="${pendingClass}">${pendingShow}</td><td class="fw-bold text-success">${fcStock.toLocaleString()}</td><td>${avgSale}</td><td class="${dohClass}">${dohShow}</td>`;
                }
                html += '</tr>';
            });
        }
        tbody.innerHTML = html;
    }
    
    function filterTable() { renderTableWithMode(); }
    function renderSkuChart(data) {
        const counts = {}; data.forEach(row => { const sku = row[4]; counts[sku] = (counts[sku] || 0) + 1; });
        const labels = Object.keys(counts); const values = Object.values(counts);
        const ctx = document.getElementById('skuChart').getContext('2d');
        if (skuChart) skuChart.destroy();
        skuChart = new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ data: values, backgroundColor: ['#e74c3c','#3498db','#f1c40f','#2ecc71','#9b59b6'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } }, datalabels: { color: '#fff', formatter: (v,c) => (v*100/c.chart.data.datasets[0].data.reduce((a,b)=>a+b,0) > 3)?v:"" } } } });
    }
    async function loadHistoryChart() { try { const r = await fetch(SCRIPT_URL + '?action=history&t=' + new Date().getTime()); const j = await r.json(); 
        if(j.status==='success'){ const l=j.data.map(r=>new Date(r[0]).toLocaleDateString('th-TH',{day:'numeric',month:'short'})); const p=j.data.map(r=>parseFloat(r[3]));
        const ctx=document.getElementById('myChart').getContext('2d'); if(myChart) myChart.destroy();
        myChart=new Chart(ctx,{type:'line',data:{labels:l,datasets:[{label:'% ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î',data:p,borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,0.1)',fill:true,tension:0.3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:true,align:'top',formatter:v=>v+'%'}}}});
    }} catch(e){}}
    async function saveDailyStats() { if(!confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥?"))return; showLoading(); try{await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:'save_daily'})}); alert("Saved"); loadHistoryChart();}catch(e){alert("Error");} finally{hideLoading();} }
    function exportToExcel() { if (allClassAData.length===0){alert("No Data");return;} let data=[]; 
        if(currentMode==='forecast'){ data.push(["Plant","Material","Desc","Stock","Pending","FcStock","AvgSale","FcDOH"]); allClassAData.forEach(r=>data.push([r[1],r[3],r[4],r[5],r[10],r[11],r[9],r[12]])); }
        else{ data.push(["PO","Plant","Material","Stock","AvgSale","DOH"]); allClassAData.forEach(r=>data.push([r[0],r[1],r[3],r[5],r[9],r[8]])); }
        const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Export"); XLSX.writeFile(wb,"Data.xlsx"); }
</script>

</body>
</html>