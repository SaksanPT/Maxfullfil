<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard & Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; padding-top: 70px; }
        
        /* üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Navbar ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (#d32f2f) ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ üî• */
        .navbar-custom { background-color: #2c3e50; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .navbar-brand { color: white !important; font-weight: bold; }
        .nav-link { color: rgba(255,255,255,0.9) !important; cursor: pointer; }
        .nav-link:hover { color: white !important; }

        /* Login Overlay */
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 9999; 
            display: none; justify-content: center; align-items: center; 
        }
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 350px; text-align: center; }

        /* Stats Cards */
        .stat-card { background: white; border-radius: 12px; padding: 15px; text-align: center; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 100%; }
        .stat-number { font-size: 1.8rem; font-weight: bold; }
        .border-blue { border-left-color: #3498db; } .text-blue { color: #3498db; }
        .border-red { border-left-color: #e74c3c; } .text-red { color: #e74c3c; }
        .border-orange { border-left-color: #f39c12; } .text-orange { color: #f39c12; }
        .border-green { border-left-color: #27ae60; } .text-green { color: #27ae60; }
        .border-fc-total { border-left-color: #6c757d; } .text-fc-total { color: #6c757d; }
        .border-fc-red { border-left-color: #c0392b; background-color: #fff5f5; } .text-fc-red { color: #c0392b; }
        .border-fc-orange { border-left-color: #d35400; } .text-fc-orange { color: #d35400; }
        .border-fc-green { border-left-color: #16a085; } .text-fc-green { color: #16a085; }
        .border-info { border-left-color: #17a2b8; } .text-info { color: #17a2b8; }
        .border-purple { border-left-color: #9b59b6; } .text-purple { color: #9b59b6; }

        /* Loading */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        /* Restricted Area */
        #restrictedSection { display: none; }

        /* üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2: ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Tabs ‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å) üî• */
        .card-header-dark {
            background-color: #2c3e50; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° (Contrast ‡∏Å‡∏±‡∏ö Tab ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß) */
            color: white;
            padding: 15px 20px 0 20px;
            border-radius: 12px 12px 0 0;
        }

        .nav-tabs { border-bottom: none; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏° Tab ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) */
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.6); /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏à‡∏≤‡∏á‡πÜ */
            font-weight: bold;
            border: none;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
        }
        
        .nav-tabs .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏° Tab ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Active) -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
        .nav-tabs .nav-link.active {
            background-color: blue; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
            color: #d32f2f; /* üî• ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß) üî• */
            border-bottom: none;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡∏π‡∏ô */
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-danger" role="status"></div>
    <div class="mt-2 text-danger fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div id="login-overlay">
    <div class="login-card">
        <h4 class="mb-4"><i class="fas fa-user-lock me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h4>
        <form onsubmit="handleLogin(event)">
            <input type="text" id="username" class="form-control mb-2" placeholder="Username" required>
            <input type="password" id="password" class="form-control mb-3" placeholder="Password" required>
            <button type="submit" class="btn btn-danger w-100 fw-bold">Login</button>
        </form>
        <button onclick="closeLogin()" class="btn btn-link text-secondary mt-2 btn-sm">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (‡∏î‡∏π Dashboard)</button>
        <div id="loginError" class="text-danger mt-2 small"></div>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
    <div class="container">
        <a class="navbar-brand" href="dashboard.html"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item"><a class="nav-link" href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Index)</a></li>
                <li class="nav-item"><a class="nav-link" href="oil_order.html">‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</a></li>
                <li class="nav-item"><a class="nav-link" href="delivery_stats.html">‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</a></li>
                <li class="nav-item"><a class="nav-link" href="po_pending.html">‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</a></li>
                <li class="nav-item ms-3">
                    <button id="btnLogin" onclick="openLogin()" class="btn btn-light btn-sm fw-bold text-danger">Login</button>
                    <div id="userMenu" style="display:none;">
                        <span class="text-white me-2" id="userDisplay">User</span>
                        <button onclick="logout()" class="btn btn-outline-light btn-sm">Logout</button>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">
    
    <h5 class="text-muted mb-3"><i class="fas fa-thumbtack me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Today)</h5>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card border-blue"><div class="stat-number text-blue" id="statTotal">-</div><small>Class A ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-red"><div class="stat-number text-red" id="statZero">-</div><small>‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î (J=0)</small></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-orange"><div class="stat-number text-orange" id="statPercent">-%</div><small>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</small></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-green"><div class="stat-number text-green" id="statNonZeroPercent">-%</div><small>‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (J‚â†0)</small></div></div>
    </div>

    <h5 class="text-muted mb-3"><i class="fas fa-magic me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ME2N)</h5>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card border-fc-total"><div class="stat-number text-fc-total" id="fcTotal">-</div><small>Class A ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-fc-red"><div class="stat-number text-fc-red" id="fcZero">-</div><small>‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</small></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-fc-orange"><div class="stat-number text-fc-orange" id="fcPercent">-%</div><small>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå)</small></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-fc-green"><div class="stat-number text-fc-green" id="fcNonZeroPercent">-%</div><small>‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå)</small></div></div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-2">
            <div class="stat-card border-info d-flex align-items-center justify-content-between px-4 py-3">
                <div class="text-start"><h2 class="stat-number text-info mb-0" id="statDOH">-</h2><div class="stat-label text-muted">DOH ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div></div>
                <i class="fas fa-box-open fa-2x text-info opacity-50"></i>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card border-purple d-flex align-items-center justify-content-between px-4 py-3">
                <div class="text-start"><h2 class="stat-number text-purple mb-0" id="statFcDOH">-</h2><div class="stat-label text-muted">Forecast DOH (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div></div>
                <i class="fas fa-chart-line fa-2x text-purple opacity-50"></i>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6"><div class="card shadow-sm h-100"><div class="card-header bg-dark text-white">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° % ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</div><div class="card-body"><canvas id="myChart" style="height:250px;"></canvas></div></div></div>
        <div class="col-md-6"><div class="card shadow-sm h-100"><div class="card-header bg-warning text-dark">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î (SKU)</div><div class="card-body"><canvas id="skuChart" style="height:250px;"></canvas></div></div></div>
    </div>

    <div id="restrictedSection">
        <div class="card border-0 shadow-sm">
            <div class="card-header-dark d-flex justify-content-between align-items-end">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-stockout" onclick="switchTab('stockout')">
                            <i class="fas fa-exclamation-triangle me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-doh" onclick="switchTab('doh')">
                            <i class="fas fa-cubes me-2"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ DOH
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-forecast" onclick="switchTab('forecast')">
                            <i class="fas fa-binoculars me-2"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
                        </button>
                    </li>
                </ul>
                <div class="pb-2">
                    <button onclick="saveDailyStats()" class="btn btn-success btn-sm fw-bold shadow-sm"><i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
                </div>
            </div>
            
            <div class="card-body border rounded-bottom border-top-0">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-5"><input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="filterTable()"></div>
                    <div class="col-md-7 text-end">
                        <span id="lastUpdate" class="text-muted small me-2">...</span>
                        <button onclick="exportToExcel()" class="btn btn-outline-success btn-sm fw-bold">Export Excel</button>
                        <button onclick="loadDashboardData()" class="btn btn-light btn-sm fw-bold text-danger">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle table-sm" id="dashTable">
                        <thead class="table-dark text-center" id="tableHeader"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="loginPrompt" class="text-center py-5 bg-light border rounded mt-4">
        <h5 class="text-muted mb-3"><i class="fas fa-lock me-2"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h5>
        <button onclick="openLogin()" class="btn btn-primary px-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbweh5uYSuJKnjpbSlFmpYwaMtsem87_-WlgFMtUjf6J4Ol_wmTJQiIxvIhMPt1-Fw9B/exec';
    
    Chart.register(ChartDataLabels);
    let allClassAData = [], currentMode = 'stockout', dohSortOrder = 'asc', myChart = null, skuChart = null;

    window.onload = function() {
        checkAuth();
        loadDashboardData();
        loadHistoryChart();
    };

    function checkAuth() {
        const user = localStorage.getItem('user');
        if (user) {
            document.getElementById('btnLogin').style.display = 'none';
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('userDisplay').innerText = user;
            document.getElementById('restrictedSection').style.display = 'block';
            document.getElementById('loginPrompt').style.display = 'none';
        } else {
            document.getElementById('btnLogin').style.display = 'block';
            document.getElementById('userMenu').style.display = 'none';
            document.getElementById('restrictedSection').style.display = 'none';
            document.getElementById('loginPrompt').style.display = 'block';
        }
    }

    function openLogin() { document.getElementById('login-overlay').style.display = 'flex'; }
    function closeLogin() { document.getElementById('login-overlay').style.display = 'none'; }

    async function handleLogin(e) {
        e.preventDefault();
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: u, password: p }) });
            const json = await res.json();
            if (json.status === 'success') {
                localStorage.setItem('user', json.username);
                localStorage.setItem('role', json.role);
                location.reload(); 
            } else {
                document.getElementById('loginError').innerText = json.message;
            }
        } catch(err) { alert("Error: " + err); }
    }

    function logout() { if(confirm("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { localStorage.clear(); location.reload(); } }

    async function loadDashboardData() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            const res = await fetch(SCRIPT_URL + '?action=dashboard&t=' + new Date().getTime());
            const json = await res.json();
            if (json.status === 'success') {
                const s = json.stats;
                document.getElementById('statTotal').innerText = s.totalClassA;
                document.getElementById('statZero').innerText = s.zeroStock;
                document.getElementById('statPercent').innerText = ((s.zeroStock/s.totalClassA)*100).toFixed(2)+"%";
                document.getElementById('statNonZeroPercent').innerText = (100 - ((s.zeroStock/s.totalClassA)*100)).toFixed(2)+"%";
                document.getElementById('statDOH').innerText = Number(s.totalDOH).toFixed(2) + " ‡∏ß‡∏±‡∏ô";

                document.getElementById('fcTotal').innerText = s.totalClassA;
                document.getElementById('fcZero').innerText = s.fcZeroStock;
                document.getElementById('fcPercent').innerText = ((s.fcZeroStock/s.totalClassA)*100).toFixed(2)+"%";
                document.getElementById('fcNonZeroPercent').innerText = (100 - ((s.fcZeroStock/s.totalClassA)*100)).toFixed(2)+"%";
                document.getElementById('statFcDOH').innerText = Number(s.fcTotalDOH).toFixed(2) + " ‡∏ß‡∏±‡∏ô";

                allClassAData = json.data;
                const zeroStockItems = allClassAData.filter(r => parseFloat(r[5]) === 0);
                renderSkuChart(zeroStockItems);
                renderTableWithMode();
                document.getElementById('lastUpdate').innerText = `Updated: ${new Date().toLocaleTimeString('th-TH')}`;
            }
        } catch (err) { console.error(err); }
        finally { document.getElementById('loadingOverlay').style.display = 'none'; }
    }

    function renderTableWithMode() {
        const thead = document.getElementById('tableHeader');
        let displayData = [];
        if (currentMode === 'stockout') {
            thead.innerHTML = `<tr><th>PO</th><th>Plant</th><th>Material</th><th>Description</th><th class="bg-danger text-white">Stock</th><th>Unit</th><th class="bg-warning text-dark">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 30 ‡∏ß‡∏±‡∏ô</th></tr>`;
            displayData = allClassAData.filter(r => parseFloat(r[5]) === 0);
        } else if (currentMode === 'doh') {
            let sortIcon = (dohSortOrder === 'asc') ? '<i class="fas fa-sort-amount-down-alt ms-2"></i>' : '<i class="fas fa-sort-amount-up ms-2"></i>';
            thead.innerHTML = `<tr><th>PO</th><th>Plant</th><th>Material</th><th>Description</th><th class="bg-secondary text-white">Stock</th><th class="bg-info text-white">Avg Sales/Day</th><th class="bg-primary text-white sortable-header" onclick="toggleDohSort()" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö">DOH (‡∏ß‡∏±‡∏ô) ${sortIcon}</th></tr>`;
            displayData = [...allClassAData].sort((a,b) => (dohSortOrder === 'asc') ? (a[8]-b[8]) : (b[8]-a[8]));
        } else if (currentMode === 'forecast') {
            let sortIcon = (dohSortOrder === 'asc') ? '<i class="fas fa-sort-amount-down-alt ms-2"></i>' : '<i class="fas fa-sort-amount-up ms-2"></i>';
            thead.innerHTML = `<tr><th>Plant</th><th>Material</th><th class="bg-secondary text-white">Stock ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th><th class="bg-warning text-dark">‡∏£‡∏≠‡∏£‡∏±‡∏ö (Liters)</th><th class="bg-success text-white">‡∏£‡∏ß‡∏° Stock (Calc)</th><th class="bg-info text-white">Avg Sale</th><th class="bg-purple text-white sortable-header" onclick="toggleDohSort()" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö Forecast DOH">FC DOH ${sortIcon}</th></tr>`;
            displayData = [...allClassAData].sort((a,b) => (dohSortOrder === 'asc') ? (a[12]-b[12]) : (b[12]-a[12]));
        }
        renderTableBody(displayData);
    }

    function renderTableBody(rows) {
        const tbody = document.getElementById('tableBody');
        const v = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rows.filter(r => r.some(c => String(c).toLowerCase().includes(v)));
        let html = '';
        if (filtered.length === 0) { html = '<tr><td colspan="100%" class="text-center py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; } 
        else {
            filtered.forEach(row => {
                let stock = Number(row[5]).toLocaleString();
                let avgSale = Number(row[9]).toFixed(2);
                html += '<tr>';
                if (currentMode === 'stockout') {
                     html += `<td>${row[0]}</td><td>${row[1]}</td><td>${row[3]}</td><td class="text-start">${row[4]}</td><td class="fw-bold text-danger">0</td><td>${row[6]}</td><td class="fw-bold text-end">${Number(row[7]).toLocaleString()}</td>`;
                } else if (currentMode === 'doh') {
                     let dohShow = (row[8] > 9000) ? "‚àû" : Number(row[8]).toFixed(2);
                     let dohClass = (row[8] < 7) ? "text-danger fw-bold" : (row[8] < 15) ? "text-warning fw-bold" : "text-success";
                     html += `<td>${row[0]}</td><td>${row[1]}</td><td>${row[3]}</td><td class="text-start">${row[4]}</td><td>${stock}</td><td class="text-info">${avgSale}</td><td class="${dohClass}">${dohShow}</td>`;
                } else if (currentMode === 'forecast') {
                     let pending = Number(row[10]);
                     let fcStock = Number(row[11]);
                     let fcDoh = row[12];
                     let pendingShow = pending > 0 ? `+${pending.toLocaleString()}` : "-";
                     let dohShow = (fcDoh > 9000) ? "‚àû" : Number(fcDoh).toFixed(2);
                     let dohClass = (fcDoh < 7) ? "text-danger fw-bold" : (fcDoh < 15) ? "text-warning fw-bold" : "text-success";
                     html += `<td>${row[1]}</td><td>${row[3]} <small class="d-block text-muted text-truncate" style="max-width:150px;">${row[4]}</small></td><td>${stock}</td><td class="text-warning">${pendingShow}</td><td class="fw-bold text-success">${fcStock.toLocaleString()}</td><td>${avgSale}</td><td class="${dohClass}">${dohShow}</td>`;
                }
                html += '</tr>';
            });
        }
        tbody.innerHTML = html;
    }
    
    function filterTable() { renderTableWithMode(); }
    function switchTab(mode) { currentMode = mode; document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + mode).classList.add('active'); renderTableWithMode(); }
    function toggleDohSort() { dohSortOrder = (dohSortOrder === 'asc') ? 'desc' : 'asc'; renderTableWithMode(); }

    function renderSkuChart(data) {
        const counts = {}; data.forEach(row => { const sku = row[4]; counts[sku] = (counts[sku] || 0) + 1; });
        const ctx = document.getElementById('skuChart').getContext('2d');
        if (skuChart) skuChart.destroy();
        skuChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#e74c3c','#3498db','#f1c40f','#2ecc71'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } } });
    }
    async function loadHistoryChart() { try { const r = await fetch(SCRIPT_URL + '?action=history&t=' + new Date().getTime()); const j = await r.json(); 
        if(j.status==='success'){ const l=j.data.map(r=>new Date(r[0]).toLocaleDateString('th-TH',{day:'numeric',month:'short'})); const p=j.data.map(r=>parseFloat(r[3]));
        const ctx=document.getElementById('myChart').getContext('2d'); if(myChart) myChart.destroy();
        myChart=new Chart(ctx,{type:'line',data:{labels:l,datasets:[{label:'% ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î',data:p,borderColor:'#e74c3c',fill:true,backgroundColor:'rgba(231,76,60,0.1)',tension:0.3}]},options:{responsive:true,maintainAspectRatio:false}});
    }} catch(e){}}
    async function saveDailyStats() { if(!confirm("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥?"))return; document.getElementById('loadingOverlay').style.display='flex'; try{await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify({action:'save_daily'})}); alert("Saved");}catch(e){alert("Error");} finally{document.getElementById('loadingOverlay').style.display='none';} }
    function exportToExcel() { if (allClassAData.length===0){alert("No Data");return;} let data=[]; 
        if(currentMode==='forecast'){ data.push(["Plant","Material","Desc","Stock","Pending","FcStock","AvgSale","FcDOH"]); allClassAData.forEach(r=>data.push([r[1],r[3],r[4],r[5],r[10],r[11],r[9],r[12]])); }
        else{ data.push(["PO","Plant","Material","Stock","AvgSale","DOH"]); allClassAData.forEach(r=>data.push([r[0],r[1],r[3],r[5],r[9],r[8]])); }
        const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Export"); XLSX.writeFile(wb,"Data.xlsx"); }
</script>
</body>
</html>