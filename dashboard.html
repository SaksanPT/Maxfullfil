<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Class A</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .dashboard-card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; background: white; margin-bottom: 20px; }
        .card-header { background: #d32f2f; color: white; padding: 15px 20px; }
        
        .stat-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; height: 100%; border-left: 5px solid #ccc; }
        .stat-number { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #666; font-size: 0.9rem; }
        
        .border-blue { border-left-color: #3498db; } .text-blue { color: #3498db; }
        .border-red { border-left-color: #e74c3c; } .text-red { color: #e74c3c; }
        .border-orange { border-left-color: #f39c12; } .text-orange { color: #f39c12; }
        .border-green { border-left-color: #27ae60; } .text-green { color: #27ae60; }

        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="mt-3 fw-bold text-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
</div>

<div class="container py-4">
    <div class="d-flex justify-content-between mb-3">
        <a href="index.html" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <button onclick="saveDailyStats()" class="btn btn-success fw-bold"><i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>

    <h5 class="text-muted mb-3">üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Today)</h5>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card border-blue"><div class="stat-number text-blue" id="statTotal">-</div><div class="stat-label">Class A ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-red"><div class="stat-number text-red" id="statZero">-</div><div class="stat-label">‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î (J=0)</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-orange"><div class="stat-number text-orange" id="statPercent">-%</div><div class="stat-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card border-green"><div class="stat-number text-green" id="statNonZeroPercent">-%</div><div class="stat-label">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (J‚â†0)</div></div></div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="dashboard-card card">
                <div class="card-header bg-dark text-white"><h5 class="m-0"><i class="fas fa-chart-line me-2"></i>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° % ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î</h5></div>
                <div class="card-body"><div style="height: 300px;"><canvas id="myChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="dashboard-card card">
                <div class="card-header bg-warning text-dark"><h5 class="m-0"><i class="fas fa-chart-pie me-2"></i>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î (‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏ï‡∏≤‡∏° SKU)</h5></div>
                <div class="card-body"><div style="height: 300px;"><canvas id="skuChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="dashboard-card card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="m-0"><i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î (Stock=0)</h5>
            <div class="d-flex gap-2">
                <button onclick="exportToExcel()" class="btn btn-outline-light btn-sm fw-bold"><i class="fas fa-file-excel"></i> Export Excel</button>
                <button onclick="loadDashboardData()" class="btn btn-light btn-sm fw-bold text-danger"><i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6"><input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="filterTable()"></div>
                <div class="col-md-6 text-end align-self-center"><span id="lastUpdate" class="text-muted small">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</span></div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="dashTable">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>PO</th><th>Plant</th><th>Class</th><th>Material</th><th>Description</th><th>Stock</th><th>Unit</th>
                            <th class="bg-warning text-dark">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 30 ‡∏ß‡∏±‡∏ô (Calc)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDhROGmEtVLx9p202hfS44dOARYM7g-x_33tIcXU_olgrcrW6wVmcyLioa1J3l3nc_/exec';
    
    let allData = [];
    let myChart = null;
    let skuChart = null;

    window.onload = function() {
        loadDashboardData();
        loadHistoryChart();
    };

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    async function loadDashboardData() {
        showLoading();
        try {
            const res = await fetch(SCRIPT_URL + '?action=dashboard&t=' + new Date().getTime());
            const json = await res.json();
            
            if (json.status !== 'success') throw new Error(json.message);

            if (json.stats) {
                const total = json.stats.totalClassA;
                const zero = json.stats.zeroStock;
                const nonZero = total - zero;
                const zeroPercent = total > 0 ? ((zero / total) * 100).toFixed(2) : 0;
                const nonZeroPercent = total > 0 ? ((nonZero / total) * 100).toFixed(2) : 0;

                document.getElementById('statTotal').innerText = total.toLocaleString();
                document.getElementById('statZero').innerText = zero.toLocaleString();
                document.getElementById('statPercent').innerText = zeroPercent + "%";
                document.getElementById('statNonZeroPercent').innerText = nonZeroPercent + "%";
            }

            const rawData = json.data; 
            if (!rawData || rawData.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="100%" class="text-center py-5">‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</td></tr>';
                document.getElementById('lastUpdate').innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            } else {
                allData = rawData;
                renderTable(allData);
                renderSkuChart(allData);
                document.getElementById('lastUpdate').innerText = `Updated: ${new Date().toLocaleTimeString('th-TH')}`;
            }
        } catch (err) { alert("Error: " + err.message); }
        finally { hideLoading(); }
    }

    function renderSkuChart(data) {
        const counts = {};
        data.forEach(row => {
            const skuName = row[4]; 
            counts[skuName] = (counts[skuName] || 0) + 1;
        });

        const labels = Object.keys(counts);
        const values = Object.values(counts);

        const ctx = document.getElementById('skuChart').getContext('2d');
        if (skuChart) skuChart.destroy();

        skuChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6', '#e67e22', '#34495e', '#16a085'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: {size: 10} } },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.raw} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` } }
                }
            }
        });
    }

    async function loadHistoryChart() {
        try {
            const res = await fetch(SCRIPT_URL + '?action=history&t=' + new Date().getTime());
            const json = await res.json();
            if (json.status === 'success') {
                renderChart(json.data);
            }
        } catch (err) { console.error("Chart Error:", err); }
    }

    function renderChart(data) {
        const labels = data.map(row => {
            let d = new Date(row[0]);
            return isNaN(d) ? row[0].substring(5) : d.toLocaleDateString('th-TH', {day:'numeric', month:'short'});
        });
        const percents = data.map(row => parseFloat(row[3]));

        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '% ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î',
                    data: percents,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#e74c3c'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: {display: true, text: 'Percentage (%)'} }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    async function saveDailyStats() {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?")) return;
        showLoading();
        try {
            const res = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: 'save_daily' })
            });
            const json = await res.json();
            alert(json.message);
            loadHistoryChart();
        } catch (err) { alert("Error: " + err); }
        finally { hideLoading(); }
    }

    function renderTable(rows) {
        const tbody = document.getElementById('tableBody');
        let html = '';
        rows.forEach(row => {
            html += '<tr>';
            row.forEach((cell, i) => {
                let cls = '';
                if (i === 5) cls = 'text-center fw-bold text-danger'; 
                if (i === 7) cls = 'text-end fw-bold text-primary'; 
                
                let displayVal = cell;
                if (i === 7 && !isNaN(cell)) {
                    // üî•üî• Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°) üî•üî•
                    displayVal = Number(cell).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); 
                }

                html += `<td class="${cls}">${displayVal}</td>`;
            });
            html += '</tr>';
        });
        tbody.innerHTML = html;
    }
    
    function filterTable() {
        const v = document.getElementById('searchInput').value.toLowerCase();
        const f = allData.filter(r=>r.some(c=>String(c).toLowerCase().includes(v)));
        renderTable(f);
    }

    function exportToExcel() {
        if (allData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export"); return; }
        const header = ["PO", "Plant", "Class", "Material", "Description", "Stock", "Unit", "Sales 30 Days"];
        const exportData = [header, ...allData];
        const ws = XLSX.utils.aoa_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Zero_Stock_Data");
        XLSX.writeFile(wb, "Zero_Stock_Items.xlsx");
    }
</script>

</body>
</html>